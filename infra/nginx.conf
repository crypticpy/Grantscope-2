# =============================================================================
# GrantScope2 — API Gateway (nginx)
# =============================================================================
# Mirrors Supabase Cloud's URL structure so that supabase-py and supabase-js
# clients work without any code changes.
#
# Routes:
#   /rest/v1/*  -> PostgREST (port 3000)   — database REST API
#   /auth/v1/*  -> GoTrue    (port 9999)   — authentication
#   /health     -> 200 OK                  — gateway health check
# =============================================================================

server {
    listen 8000;
    server_name _;

    # Max request body (file uploads, large payloads)
    client_max_body_size 10m;

    # ---------------------------------------------------------------------------
    # PostgREST — Database REST API
    # ---------------------------------------------------------------------------
    # supabase-py sends requests to {base_url}/rest/v1/{table}
    # PostgREST serves at root, so we strip the /rest/v1 prefix.
    location /rest/v1/ {
        proxy_pass http://postgrest:3000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;
        proxy_set_header Accept $http_accept;
        proxy_set_header Content-Type $content_type;
        proxy_set_header Prefer $http_prefer;
        proxy_set_header Range $http_range;

        # PostgREST-specific headers
        proxy_set_header ApiKey $http_apikey;
    }

    # ---------------------------------------------------------------------------
    # GoTrue — Authentication API
    # ---------------------------------------------------------------------------
    # supabase-py sends requests to {base_url}/auth/v1/{endpoint}
    # GoTrue serves at root, so we strip the /auth/v1 prefix.
    location /auth/v1/ {
        proxy_pass http://gotrue:9999/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;
        proxy_set_header Accept $http_accept;
        proxy_set_header Content-Type $content_type;

        # GoTrue-specific headers
        proxy_set_header ApiKey $http_apikey;
    }

    # ---------------------------------------------------------------------------
    # Gateway health check
    # ---------------------------------------------------------------------------
    location /health {
        return 200 '{"status":"ok","service":"grantscope-gateway"}';
        add_header Content-Type application/json;
    }

    # Catch-all: 404 for unknown routes
    location / {
        return 404 '{"error":"Not found. Use /rest/v1/ or /auth/v1/"}';
        add_header Content-Type application/json;
    }
}
